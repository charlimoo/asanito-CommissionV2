{% extends "base.html" %}
{% block title %}Ú¯Ø²Ø§Ø±Ø´ Ø¬Ø§Ù…Ø¹ Ù¾ÙˆØ±Ø³Ø§Ù†Øª{% endblock %}

{% block content %}
{# Embed the complete frontend data as JSON for JavaScript to consume #}
<script>
    const frontendData = {{ frontend_data|tojson }};
</script>

{# Page Header #}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="display-6 fw-bold">Ú¯Ø²Ø§Ø±Ø´ Ø¬Ø§Ù…Ø¹ Ù¾ÙˆØ±Ø³Ø§Ù†Øª</h1>
        <p class="text-muted">Ù†ØªØ§ÛŒØ¬ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙØ§ÛŒÙ„: <strong>{{ run.filename }}</strong> | Ø¯ÙˆØ±Ù‡: <strong>{{ run.report_period }}</strong></p>
    </div>
    <div>
        <!-- PDF Export link can be re-enabled later if needed -->
        {% if not is_user_view %}
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¬Ø¯ÛŒØ¯</a>
        {% else %}
        <a href="{{ url_for('main.admin_logout') }}" class="btn btn-outline-danger">Ø®Ø±ÙˆØ¬</a>
        {% endif %}
    </div>
</div>

{# 1. Person Filter Bar -- THIS IS THE CORE OF PHASE 5 #}
{% if not is_user_view and person_list|length > 1 %}
<div class="card shadow-sm mb-4">
    <div class="card-header fw-bold">ÙÛŒÙ„ØªØ± Ø§ÙØ±Ø§Ø¯</div>
    <div class="card-body" id="person-filter-container">
        <div class="form-check form-check-inline">
            <input class="form-check-input" type="checkbox" id="selectAllCheckbox" checked>
            <label class="form-check-label" for="selectAllCheckbox"><b>Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ù…Ù‡</b></label>
        </div>
        <hr>
        {% for person in person_list %}
        <div class="form-check form-check-inline">
            <input class="form-check-input person-filter" type="checkbox" id="filter-{{ person.replace(' ', '-') }}" value="{{ person }}" checked>
            <label class="form-check-label" for="filter-{{ person.replace(' ', '-') }}">{{ person }}</label>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{# END OF CONDITIONAL BLOCK #}

{# 2. Performance-over-Time Chart #}
<div class="card shadow-sm mb-4">
    <div class="card-header fw-bold">Ù†Ù…ÙˆØ¯Ø§Ø± ÙØ±ÙˆØ´ Ù…Ø§Ù‡Ø§Ù†Ù‡ (Ù…Ø¨Ù†Ø§ÛŒ Ù¾Ù„Ù‡)</div>
    <div class="card-body">
        <div style="height: 400px;">
            <canvas id="performanceChart"></canvas>
        </div>
    </div>
</div>

{# 3. Overall Summary Table #}
<div class="card shadow-sm mb-4">
    <div class="card-header fw-bold">Ø®Ù„Ø§ØµÙ‡ Ù¾ÙˆØ±Ø³Ø§Ù†Øª Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ Ú©Ù„ÛŒ</div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="summary-table">
                <thead class="table-dark">
                    <tr>
                        <th>Ù†Ø§Ù…</th>
                        <th>Ú©Ù„ Ù¾ÙˆØ±Ø³Ø§Ù†Øª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡</th>
                        <th>Ù…Ø¬Ù…ÙˆØ¹ Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª</th>
                        <th>Ù¾ÙˆØ±Ø³Ø§Ù†Øª Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ÙˆØµÙˆÙ„</th>
                        <th>Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡</th>
                        <th>Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ù„Ø§Ø²Ù… Ø¨Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª</th>
                    </tr>
                </thead>
                <tbody id="summary-table-body">
                {% for summary in overall_summary|sort(attribute='person_name') %}
                    <tr data-person-name="{{ summary.person_name }}">
                        <td><strong>ğŸ‘¤ {{ summary.person_name }}</strong></td>
                        <td>{{ summary.total_full_commission|to_persian_int }} ØªÙˆÙ…Ø§Ù†</td>
                        <td class="fw-bold">{{ summary.total_payable_commission|to_persian_int }} ØªÙˆÙ…Ø§Ù†</td>
                        <td class="text-warning">{{ summary.total_pending_commission|to_persian_int }} ØªÙˆÙ…Ø§Ù†</td>
                        <td>{{ summary.total_paid_commission|to_persian_int }} ØªÙˆÙ…Ø§Ù†</td>
                        <td class="fw-bold {% if summary.remaining_balance > 0 %}text-success{% elif summary.remaining_balance < 0 %}text-danger{% endif %}">
                            {% if summary.remaining_balance > 0 %}âœ”ï¸ {% elif summary.remaining_balance < 0 %}âš ï¸ {% endif %}
                            {{ summary.remaining_balance|to_persian_int }} ØªÙˆÙ…Ø§Ù†
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{# The rest of the report template remains the same #}
<!-- ... -->
{# Main Tab Navigation for Detailed Reports #}
<ul class="nav nav-tabs nav-fill mb-3" id="reportTab" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="detailed-calc-tab" data-bs-toggle="tab" data-bs-target="#detailed-calc-pane" type="button" role="tab">Ú¯Ø²Ø§Ø±Ø´ Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø¯Ù‚ÛŒÙ‚ (Ù…Ø§Ù‡ Ø¨Ù‡ Ù…Ø§Ù‡)</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="person-monthly-tab" data-bs-toggle="tab" data-bs-target="#person-monthly-pane" type="button" role="tab">Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù‡Ø§Ù†Ù‡ Ø§ÙØ±Ø§Ø¯</button>
  </li>
</ul>

<div class="tab-content" id="reportTabContent">
  {# 4. Step-by-Step Calculation View #}
  <div class="tab-pane fade show active" id="detailed-calc-pane" role="tabpanel">
    <div class="accordion" id="monthAccordion">
        {% for month_key, month_data in detailed_report.items()|sort %}
        <div class="accordion-item shadow-sm mb-2 report-month-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-month-{{ month_key }}">
                    <div class="w-100 d-flex justify-content-between align-items-center pe-3">
                        <span class="fs-5">ğŸ—“ï¸ <strong class="ms-2">Ù…Ø§Ù‡ {{ month_key }}</strong></span>
                        <span class="report-header-stat">
                            <span class="text-muted">ğŸ“ˆ Ú©Ù„ ÙØ±ÙˆØ´:</span> {{ month_data.total_net_sales|to_persian_int }} ØªÙˆÙ…Ø§Ù†
                        </span>
                        <span class="report-header-stat">
                            <span class="text-muted">ğŸ’° Ú©Ù„ Ù¾ÙˆØ±Ø³Ø§Ù†Øª:</span> <strong class="text-success">{{ month_data.total_commission|to_persian_int }} ØªÙˆÙ…Ø§Ù†</strong>
                        </span>
                    </div>
                </button>
            </h2>
            <div id="collapse-month-{{ month_key }}" class="accordion-collapse collapse" data-bs-parent="#monthAccordion">
                <div class="accordion-body">
                    {# Monthly Bonus Summary #}
                    {% if month_data.bonus_summary %}
                    <div class="alert alert-info small">
                        <strong>Ø®Ù„Ø§ØµÙ‡ Ù¾Ø§Ø¯Ø§Ø´ Ù…Ø§Ù‡:</strong><br>
                        - <strong>Ø¬Ù…Ø¹ÛŒ:</strong> Ù‡Ø¯Ù: {{ month_data.bonus_summary.collective_target|to_persian_int }} | Ù…Ø¨Ù„Øº Ú©Ù„: <span class="fw-bold">{{ month_data.bonus_summary.collective_amount|to_persian_int }} ØªÙˆÙ…Ø§Ù†</span><br>
                        - <strong>ÙØ±Ø¯ÛŒ:</strong> Ù‡Ø¯Ù: {{ month_data.bonus_summary.individual_target|to_persian_int }} | Ù…Ø¨Ù„Øº Ú©Ù„: <span class="fw-bold">{{ month_data.bonus_summary.individual_amount|to_persian_int }} ØªÙˆÙ…Ø§Ù†</span><br>
                        - <strong>ØªØ§Ù¾ Ø³Ù„Ø±:</strong> {{ month_data.bonus_summary.top_seller_name }} ({{ month_data.bonus_summary.top_seller_sales|to_persian_int }}) | Ù…Ø¨Ù„Øº Ú©Ù„: <span class="fw-bold">{{ month_data.bonus_summary.top_seller_amount|to_persian_int }} ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                    {% endif %}

                    {% for person_name, person_data in month_data.persons.items()|sort %}
                    <div class="card mb-3 report-person-item" data-person-name="{{ person_name }}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">ğŸ‘¤ {{ person_name }}</h5>
                            <div class="person-summary-stats">
                                <span class="me-4"><span class="text-muted">Ù…Ø¨Ù†Ø§ÛŒ Ù¾Ù„Ù‡:</span> {{ person_data.bracket_base|to_persian_int }}</span>
                                <span class="me-4"><span class="text-muted">Ù¾Ø§Ø¯Ø§Ø´:</span> {{ person_data.additional_bonus|to_persian_int }}</span>
                                <span><span class="text-muted">ğŸ’° Ù¾ÙˆØ±Ø³Ø§Ù†Øª Ú©Ù„:</span> <strong class="text-success">{{ person_data.total_commission|to_persian_int }}</strong></span>
                            </div>
                        </div>
                        <div class="accordion" id="personAccordion-{{ month_key }}-{{ person_name.replace(' ', '-') }}">
                            {% for role, summary in person_data.roles_summary.items()|sort %}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-role-{{ month_key }}-{{ person_name.replace(' ', '-') }}-{{ role.replace(' ', '-') }}">
                                        <div class="w-100 d-flex justify-content-between pe-3">
                                            <span><strong>Ù†Ù‚Ø´:</strong> {{ role }}</span>
                                            <span><span class="text-muted">ØªØ¹Ø¯Ø§Ø¯:</span> {{ summary.transaction_count }}</span>
                                            <span><span class="text-muted">Ù¾ÙˆØ±Ø³Ø§Ù†Øª:</span> <strong class="text-primary">{{ summary.total_commission|to_persian_int }}</strong></span>
                                        </div>
                                    </button>
                                </h2>
                                <div id="collapse-role-{{ month_key }}-{{ person_name.replace(' ', '-') }}-{{ role.replace(' ', '-') }}" class="accordion-collapse collapse" data-bs-parent="#personAccordion-{{ month_key }}-{{ person_name.replace(' ', '-') }}">
                                    <div class="accordion-body">
                                        {% for txn in person_data.transactions if txn.role == role %}
                                        <div class="transaction-card">
                                            <div class="transaction-header">
                                                <span>Ø´Ø±Ú©Øª: <a href="{{ txn.invoice_link }}" target="_blank"><strong>{{ txn.company }}</strong></a></span>
                                                <span class="fw-bold">Ù¾ÙˆØ±Ø³Ø§Ù†Øª: {{ txn.payable_commission|to_persian_int }} ØªÙˆÙ…Ø§Ù†</span>
                                            </div>
                                            <div class="calculation-details">
                                            {% for line in txn.calculation_details.split('\n') %}
                                                {% set parts = line.split(':', 1) %}
                                                {% if '---' in line %}
                                                    <hr class="calc-separator">
                                                {% elif parts|length == 2 %}
                                                    <div class="calc-row">
                                                        <span class="calc-label">{{ parts[0]|trim }}:</span>
                                                        <span class="calc-value">{{ parts[1]|trim }}</span>
                                                    </div>
                                                {% elif line|trim != "" %}
                                                    <div class="calc-row-full">{{ line|trim }}</div>
                                                {% endif %}
                                            {% endfor %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
  </div>

  {# 5. Person-Centric Monthly Report View #}
  <div class="tab-pane fade" id="person-monthly-pane" role="tabpanel">
    <div class="accordion" id="personMonthlyAccordion">
        {% for person_name, report_data in person_monthly_report.items()|sort %}
        <div class="accordion-item shadow-sm mb-2 border-0 report-person-item" data-person-name="{{ person_name }}">
            <h2 class="accordion-header"><button class="accordion-button collapsed fs-5" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-person-{{ person_name.replace(' ', '-') }}"><strong class="ms-2">ğŸ‘¤ {{ person_name }}</strong> | Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ú©Ù„: <span class="badge bg-primary">{{ report_data.total_unpaid|to_persian_int }} ØªÙˆÙ…Ø§Ù†</span></button></h2>
            <div id="collapse-person-{{ person_name.replace(' ', '-') }}" class="accordion-collapse collapse" data-bs-parent="#personMonthlyAccordion">
                <div class="accordion-body">
                    {% for month, data in report_data.months.items()|sort %}
                    <div class="list-group-item list-group-item-action flex-column align-items-start mb-2 p-3 border rounded">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">ğŸ—“ï¸ Ù…Ø§Ù‡ {{ month }}</h5>
                            <div>
                                <small class="me-3">Ù…Ø¨Ù†Ø§ÛŒ Ù¾Ù„Ù‡: {{ data.bracket_base|to_persian_int }} ØªÙˆÙ…Ø§Ù†</small>
                                <small>Ú©Ù„ Ø®Ø§Ù„Øµ ÙØ§Ú©ØªÙˆØ±: {{ data.total_net_sales|to_persian_int }} ØªÙˆÙ…Ø§Ù†</small>
                            </div>
                        </div>
                        <p class="mb-1">
                            <span class="me-3">Ù¾ÙˆØ±Ø³Ø§Ù†Øª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ (Ù¾ØªØ§Ù†Ø³ÛŒÙ„): <strong class="text-secondary">{{ data.full_commission|to_persian_int }} ØªÙˆÙ…Ø§Ù†</strong></span>
                        </p>
                        <p class="mb-1">
                            <span class="me-3">Ù¾ÙˆØ±Ø³Ø§Ù†Øª Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ÙˆØµÙˆÙ„: <strong class="text-warning">{{ data.pending_commission|to_persian_int }} ØªÙˆÙ…Ø§Ù†</strong></span>
                        </p>
                         <p class="mb-1">
                             <span class="me-3">Ù¾Ø§Ø¯Ø§Ø´: <strong class="text-info">{{ data.additional_bonus|to_persian_int }} ØªÙˆÙ…Ø§Ù†</strong></span>
                        </p>
                        <p class="mb-0 fw-bold">ğŸ’° Ù…Ø¬Ù…ÙˆØ¹ Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª Ø§ÛŒÙ† Ù…Ø§Ù‡: <span class="text-success">{{ data.total_commission|to_persian_int }} ØªÙˆÙ…Ø§Ù†</span></p>
                    </div>
                    {% else %}
                    <p class="text-muted">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø´Ø®Øµ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/report.js') }}"></script>
{% endblock %}